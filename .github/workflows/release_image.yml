name: Auto Build and Publish on New Release

permissions:
  contents: write
on:
  schedule:
    - cron: "0 6 * * *"   # every day at 6 AM UTC
  workflow_dispatch:       # also allow manual trigger

jobs:
  check-and-build:
    runs-on: RISCV64

    steps:
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gh wget gawk git libatomic1 jq docker.io podman
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Get latest release tag from github-runner-riscv
        id: get_latest
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/alitariq4589/github-runner-riscv/releases/latest | jq -r .tag_name)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest release tag is: $LATEST_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read last built tag (if any)
        id: read_last
        run: |
          if [ -f .last_built_tag ]; then
            echo "last_tag=$(cat .last_built_tag)" >> $GITHUB_OUTPUT
            echo "Last built tag: $(cat .last_built_tag)"
          else
            echo "last_tag=" >> $GITHUB_OUTPUT
            echo "No previous build record found"
          fi

      - name: Check if new release exists
        id: compare
        run: |
          if [ "${{ steps.get_latest.outputs.latest_tag }}" = "${{ steps.read_last.outputs.last_tag }}" ]; then
            echo "No new release. Skipping build."
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New release detected!"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no new release
        if: steps.compare.outputs.should_build == 'false'
        run: |
          echo "âœ… Everything up to date â€” no build required."
          exit 0

      # --- Only runs when new release detected ---
      - name: Download latest release assets
        if: steps.compare.outputs.should_build == 'true'
        run: |
          mkdir release && cd release
          gh release download "${{ steps.get_latest.outputs.latest_tag }}" \
            --repo alitariq4589/github-runner-riscv \
            --pattern "*" --clobber
          ls -lh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Set up Docker Buildx
        # if: steps.compare.outputs.should_build == 'true'
        # uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        if: steps.compare.outputs.should_build == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image with Podman
        run: |
          set -ex
          export BUILDAH_ISOLATION=chroot
          export _CONTAINERS_USERNS_CONFIGURED=""
          export PODMAN_SYSTEMD_UNIT=
          sudo podman build -t ${{ secrets.DOCKERHUB_USERNAME }}/github-runner-riscv:latest .
          sudo podman login docker.io -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
          sudo podman push ${{ secrets.DOCKERHUB_USERNAME }}/github-runner-riscv:latest docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/github-runner-riscv:latest



      - name: Save the latest tag as built
        if: steps.compare.outputs.should_build == 'true'
        run: |
          LATEST_TAG=${{ steps.get_latest.outputs.latest_tag }}

          echo "$LATEST_TAG" > .last_built_tag

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .last_built_tag
          git commit -m "CI: record built release $LATEST_TAG"
          
          echo "ðŸ†• Committed updated .last_built_tag"

          # Push changes
          echo "ðŸš€ Pushing to origin..."
          git push origin HEAD:main
